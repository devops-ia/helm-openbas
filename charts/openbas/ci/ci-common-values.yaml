replicaCount: 1
fullnameOverride: openbas-ci

strategy:
  type: Recreate

env:
  # OPENBAS
  OPENBAS_ADMIN_EMAIL: admin@openbas.io
  OPENBAS_BASE-URL: http://openbas-ci-server:80

  # CALDERA
  INJECTOR_CALDERA_PUBLIC_URL: http://openbas-ci-caldera:8888
  INJECTOR_CALDERA_URL: http://openbas-ci-caldera:8888

  ## OPENSEARCH
  ENGINE_ENGINE_SELECTOR: opensearch
  ENGINE_URL: http://openbas-ci-opensearch:9200

  # STORAGE
  MINIO_ENDPOINT: openbas-ci-minio

  # MESSAGE QUEUE
  OPENBAS_RABBITMQ_HOSTNAME: openbas-ci-rabbitmq
  OPENBAS_RABBITMQ_MANAGEMENT-PORT: 15672
  OPENBAS_RABBITMQ_PORT: 5672
  OPENBAS_RABBITMQ_USER: user

  # POSTGRESQL
  SPRING_DATASOURCE_URL: jdbc:postgresql://openbas-ci-postgresql:5432/openbas
  SPRING_DATASOURCE_USERNAME: user

envFromSecrets:
  OPENBAS_ADMIN_PASSWORD:
    name: openbas-ci-credentials
    key: OPENBAS_ADMIN_PASSWORD
  OPENBAS_ADMIN_TOKEN:
    name: openbas-ci-credentials
    key: OPENBAS_ADMIN_TOKEN
  INJECTOR_CALDERA_API_KEY:
    name: openbas-ci-credentials
    key: INJECTOR_CALDERA_API_KEY
  MINIO_ACCESS-KEY:
    name: openbas-ci-minio
    key: rootUser
  MINIO_ACCESS-SECRET:
    name: openbas-ci-minio
    key: rootPassword
  OPENBAS_RABBITMQ_PASS:
    name: openbas-ci-rabbitmq
    key: rabbitmq-password
  SPRING_DATASOURCE_PASSWORD:
    name: openbas-ci-postgresql
    key: password

secrets:
  - name: credentials
    data:
      OPENBAS_ADMIN_PASSWORD: dklfjkldsjnfai98y7dsaqd
      OPENBAS_ADMIN_TOKEN: b1976749-8a53-4f49-bf04-cafa2a3458c1
      INJECTOR_CALDERA_API_KEY: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82

testConnection: true

readyChecker:
  enabled: true
  retries: 30
  timeout: 5
  services:
  - name: opensearch
    port: 9200
  - name: minio
    port: 9000
  - name: postgresql
    port: 5432
  - name: rabbitmq
    port: 5672

livenessProbe:
  enabled: false

readinessProbe:
  enabled: false

startupProbe:
  enabled: false

lifecycle:
  preStop:
    exec:
      command: ["sh", "-c", "sleep 5"]

terminationGracePeriodSeconds: 20

service:
  type: ClusterIP
  port: 80
  targetPort: 8080
  protocol: TCP
  portName: http
  appProtocol: HTTP
  externalTrafficPolicy: Local
  internalTrafficPolicy: Local
  publishNotReadyAddresses: false
  sessionAffinity: None
  ipFamilies:
    - IPv4
  ipFamilyPolicy: SingleStack
  trafficDistribution: PreferClose
  labels:
    environment: ci
  extraPorts:
    - name: grpc
      port: 9000
      targetPort: 9000
      protocol: TCP
      appProtocol: GRPC

resources:
  requests:
    memory: "512Mi"
    cpu: "250m"
  limits:
    memory: "1Gi"
    cpu: "500m"

autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/os
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: openbas

##
# OPENBAS CALDERA
caldera:
  enabled: true

  env:
    CALDERA_URL: http://openbas-ci-caldera:8888

  config:
    users:
      red:
        red: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
      blue:
        blue: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    api_key_red: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    api_key_blue: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    api_key: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    crypt_salt: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    encryption_key: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    app.contact.tcp: 0.0.0.0:7010
    app.contact.udp: 0.0.0.0:7011
    app.contact.websocket: 0.0.0.0:7012
    app.contact.dns.domain: localhost
    app.contact.dns.socket: 0.0.0.0:53
    app.contact.http: http://openbas-ci-caldera:8888
    app.contact.tunnel.ssh.user_password: 0ce2182d-3e1a-4117-a1d4-8100a7b01d82
    app.contact.tunnel.ssh.socket: 0.0.0.0:8022
    app.contact.tunnel.ssh.user_name: sandcat
    objects.planners.default: atomic
    requirements:
      go:
        command: go version
        type: installed_program
        version: 1.11
      python:
        attr: version
        module: sys
        type: python_module
        version: 3.8.0
    host: 0.0.0.0
    port: 8888
    ability_refresh: 60
    plugins:
      - access
      - atomic
      - compass
      - debrief
      - fieldmanual
      - gameboard
      - manx
      - response
      - sandcat
      - stockpile
      - training

  readyChecker:
    enabled: true
    retries: 30
    timeout: 5

  lifecycle:
    preStop:
      exec:
        command: ["sh", "-c", "sleep 5"]

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi

  strategy:
    type: Recreate

  terminationGracePeriodSeconds: 20

  networkPolicy:
    enabled: true
    ingress:
      - from:
          - namespaceSelector:
              matchLabels:
                name: openbas-ci
        ports:
          - protocol: TCP
            port: 4000

  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/os
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openbas
          openbas.component: caldera

  dnsConfig:
    nameservers:
      - 1.1.1.1
      - 8.8.8.8
    searches: []
    options:
      - name: ndots
        value: "2"

  dnsPolicy: ClusterFirst

##
# OPENBAS COLLECTOR
collectorsGlobal:
  env:
    OPENBAS_URL: http://openbas-ci-server:80

  envFromSecrets:
    OPENBAS_TOKEN:
      name: openbas-ci-credentials
      key: OPENBAS_ADMIN_TOKEN

collectors:
  - name: atomic-red-team
    enabled: true
    replicas: 1

    image:
      repository: openbas/collector-atomic-red-team
      tag: latest

    resources:
      requests:
        memory: 128Mi
        cpu: 50m
      limits:
        memory: 256Mi

    serviceAccount:
      create: true
      name: openbas-collector-ci

    readyChecker:
      enabled: true
      retries: 30
      timeout: 10

    lifecycle:
      preStop:
        exec:
          command: ["sh", "-c", "sleep 10"]

    terminationGracePeriodSeconds: 20

    deploymentAnnotations:
      ci: "true"
      prometheus.io/scrape: "true"
    podAnnotations:
      ci: "true"
    podLabels:
      ci: "true"
      openbas.component: collector

    env:
      COLLECTOR_ID: e668aa07-e1a3-41d8-8748-786be5df9dab
      COLLECTOR_NAME: "Atomic Red Team"
      COLLECTOR_LOG_LEVEL: error

    envFromFiles:
      - secretRef:
          name: openbas-ci-credentials

    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/os
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: openbas
            openbas.component: collector

    dnsConfig:
      nameservers:
        - 1.1.1.1
        - 8.8.8.8
      searches: []
      options:
        - name: ndots
          value: "2"

    dnsPolicy: ClusterFirst

    strategy:
      type: Recreate

##
# OPENBAS INJECTOR
injectors:
  - name: http-query
    enabled: true
    replicas: 1

    image:
      repository: openbas/injector-http-query
      tag: latest

    resources:
      requests:
        memory: 128Mi
        cpu: 50m
      limits:
        memory: 256Mi

    serviceAccount:
      create: true

    readyChecker:
      enabled: true
      retries: 30
      timeout: 10

    lifecycle:
      preStop:
        exec:
          command: ["sh", "-c", "sleep 10"]

    terminationGracePeriodSeconds: 40

    deploymentAnnotations:
      ci: "true"
      prometheus.io/scrape: "true"
    podAnnotations:
      ci: "true"
    podLabels:
      ci: "true"
      openbas.component: injector

    env:
      INJECTOR_ID: e668aa07-e1a3-41d8-8748-786be5df9dab
      INJECTOR_NAME: "HTTP query"
      INJECTOR_LOG_LEVEL: error

    envFromSecrets:
      OPENBAS_TOKEN:
        name: openbas-ci-credentials
        key: OPENBAS_ADMIN_TOKEN

    envFromFiles:
      - secretRef:
          name: openbas-ci-credentials

    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/os
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: openbas
            openbas.component: injector

    dnsConfig:
      nameservers:
        - 1.1.1.1
        - 8.8.8.8
      searches: []
      options:
        - name: ndots
          value: "2"

    dnsPolicy: ClusterFirst

    strategy:
      type: Recreate

##
# OPENSEARCH
opensearch:
  enabled: true
  fullnameOverride: openbas-ci-opensearch

  nodeGroup: ""
  opensearchJavaOpts: "-Xmx512M -Xms512M"
  singleNode: true

  config:
    opensearch.yml: |
      plugins.security.disabled: true

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

  persistence:
    enabled: false

##
# MINIO
minio:
  fullnameOverride: openbas-ci-minio

  rootUser: minio
  rootPassword: aADSdxaXdasd8782193hdamn

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi

  persistence:
    enabled: false

##
# POSTGRESQL
postgresql:
  fullnameOverride: openbas-ci-postgresql

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi

  database: "openbas"

  primary:
    networkPolicy:
      enabled: false

    persistence:
      enabled: false

##
# RABBITMQ
rabbitmq:
  fullnameOverride: openbas-ci-rabbitmq

  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi

  auth:
    password: asdmKdskd21937xnks
    erlangCookie: c29c953e-2192-4bce-9frb-9a3a5ba76d95

  clustering:
    enabled: false

  networkPolicy:
    enabled: false

  persistence:
    enabled: false
